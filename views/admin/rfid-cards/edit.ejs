<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit RFID Card</title>
  <link rel="stylesheet" href="/css/app.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <%- include('../../partials/modal-styles') %>

  <div class="modal-content-wrapper">
    <!-- Enhanced Header -->
    <div class="modal-header-custom mb-4">
      <div class="d-flex align-items-center">
        <div class="icon-circle me-3">
          <i class="fas fa-edit text-warning"></i>
        </div>
        <div>
          <h2 class="mb-0">Edit RFID Card</h2>
          <small class="text-muted">Modify card details and assignment</small>
        </div>
      </div>
    </div>

    <!-- Card Information Display -->
    <div class="card-info-header mb-4">
      <div class="card bg-light">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="card-icon">
                <i class="fas fa-id-card fa-2x text-primary"></i>
              </div>
            </div>
            <div class="col">
              <h5 class="mb-1">Card ID: <%= card.id %></h5>
              <p class="mb-0 text-muted">
                <strong>Current UID:</strong> <code><%= card.card_uid %></code> • 
                <strong>Status:</strong> 
                <span class="badge bg-<%= card.is_active ? 'success' : 'secondary' %>">
                  <%= card.is_active ? 'Active' : 'Inactive' %>
                </span>
                <% if (card.issued_at) { %>
                  • <strong>Issued:</strong> <%= new Date(card.issued_at).toLocaleDateString() %>
                <% } %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <form action="/admin/rfid-cards/<%= card.id %>?_method=PUT" method="POST" id="editCardForm">
      <!-- Card Details Section -->
      <div class="section mb-4">
        <div class="section-header mb-3">
          <h5><i class="fas fa-credit-card me-2"></i>Card Information</h5>
          <small class="text-muted">Update the card's unique identifier</small>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="form-group mb-3">
              <label for="card_uid" class="form-label required">Card UID</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-barcode"></i>
                </span>
                <input type="text" 
                       id="card_uid" 
                       name="card_uid" 
                       class="form-control" 
                       value="<%= card.card_uid %>"
                       placeholder="Enter card UID" 
                       required>
                <button class="btn btn-outline-secondary" type="button" onclick="generateRandomUID()">
                  <i class="fas fa-random me-1"></i>Generate
                </button>
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Enter the unique identifier printed on the RFID card
              </div>
              <div class="invalid-feedback" id="card_uid_error"></div>
              <div class="valid-feedback">Card UID looks good!</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-preview">
              <div class="card bg-light text-center p-3">
                <i class="fas fa-id-card fa-3x text-muted mb-2"></i>
                <small class="text-muted">Card Preview</small>
                <div class="preview-uid mt-2">
                  <code id="preview_uid"><%= card.card_uid %></code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Assignment Section -->
      <div class="section mb-4">
        <div class="section-header mb-3">
          <h5><i class="fas fa-user-tag me-2"></i>User Assignment</h5>
          <small class="text-muted">Change card assignment or leave unassigned</small>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="form-group mb-3">
              <label for="user_search" class="form-label">Assign to User</label>
              <div class="autocomplete-container position-relative">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" 
                         id="user_search" 
                         class="form-control" 
                         value="<%= studentName || '' %>"
                         placeholder="Search by name, email, or ID">
                  <button class="btn btn-outline-secondary" type="button" onclick="clearUserSelection()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <input type="hidden" name="user_id" id="user_id" value="<%= card.user_id || '' %>">
                <div id="user_suggestions" class="suggestions-dropdown"></div>
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Search for a user to assign this card, or leave empty for unassigned
              </div>
            </div>

            <!-- Current Assignment Display -->
            <% if (card.user_id && studentName) { %>
              <div class="current-assignment mb-3">
                <div class="alert alert-info">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                      <strong>Currently assigned to:</strong> <%= studentName %>
                      <br>
                      <small>Change the search field above to reassign this card</small>
                    </div>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- Selected User Display -->
            <div id="selected_user_display" class="selected-user-card d-none">
              <div class="card border-primary">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div class="user-avatar me-3">
                      <div class="profile-initials" id="user_initials">?</div>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1" id="user_name">User Name</h6>
                      <small class="text-muted" id="user_details">Email • Role • Department</small>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearUserSelection()">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="assignment-help">
              <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                  <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                  <h6>Assignment Changes</h6>
                  <small>
                    • Changing assignment affects access rights<br>
                    • Previous user loses card access<br>
                    • New user gains card access
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Configuration Section -->
      <div class="section mb-4">
        <div class="section-header mb-3">
          <h5><i class="fas fa-cog me-2"></i>Card Configuration</h5>
          <small class="text-muted">Update card status and settings</small>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="is_active" class="form-label">Card Status</label>
              <div class="status-toggle">
                <div class="form-check form-switch form-check-lg">
                  <input class="form-check-input" 
                         type="checkbox" 
                         id="is_active" 
                         name="is_active" 
                         value="true" 
                         <%= card.is_active ? 'checked' : '' %>>
                  <label class="form-check-label" for="is_active">
                    <span class="status-text"><%= card.is_active ? 'Active' : 'Inactive' %></span>
                  </label>
                </div>
              </div>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Only active cards can be used for access control
              </div>
            </div>

            <div class="form-group mb-3">
              <label for="notes" class="form-label">Notes (Optional)</label>
              <textarea id="notes" 
                        name="notes" 
                        class="form-control" 
                        rows="3" 
                        placeholder="Add any notes about this card..."><%= card.notes || '' %></textarea>
            </div>
          </div>
          <div class="col-md-6">
            <div class="configuration-summary">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Update Summary</h6>
                </div>
                <div class="card-body">
                  <div class="summary-item">
                    <strong>Card UID:</strong> <span id="summary_uid"><%= card.card_uid %></span>
                  </div>
                  <div class="summary-item">
                    <strong>Assigned to:</strong> <span id="summary_user"><%= studentName || 'Unassigned' %></span>
                  </div>
                  <div class="summary-item">
                    <strong>Status:</strong> <span id="summary_status"><%= card.is_active ? 'Active' : 'Inactive' %></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions mt-4">
        <div class="d-flex justify-content-between">
          <div class="form-info">
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              Last modified: <%= new Date(card.updated_at || card.created_at).toLocaleString() %>
            </small>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-warning" id="updateBtn">
              <i class="fas fa-save me-1"></i>Update RFID Card
            </button>
            <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    let selectedUser = null;

    $(document).ready(function(){
      initializeEditForm();
      setupEventListeners();
    });

    function initializeEditForm() {
      // Initialize form validation
      updateSummary();
      
      // Setup real-time validation
      $('#card_uid').on('input', function() {
        validateCardUID();
        updatePreview();
        updateSummary();
      });

      $('#is_active').on('change', function() {
        updateStatusDisplay();
        updateSummary();
      });

      // Initialize status display
      updateStatusDisplay();

      // Initialize with current user if assigned
      <% if (card.user_id && studentName) { %>
        // Pre-populate with existing assignment
        selectedUser = {
          id: '<%= card.user_id %>',
          first_name: '<%= studentName.split(" ")[0] %>',
          last_name: '<%= studentName.split(" ").slice(1).join(" ") %>'
        };
      <% } %>
    }

    function setupEventListeners() {
      // Enhanced user search with all user types
      $('#user_search').on('input', function(){
        const query = $(this).val().trim();
        if(query.length < 2){
          $('#user_suggestions').empty().hide();
          return;
        }

        // Search all users, not just students
        $.ajax({
          url: '/admin/users/search',
          data: { q: query, include_all: true },
          success: function(data){
            displayUserSuggestions(data.users || data.students || []);
          },
          error: function(xhr) {
            // Fallback to students search if users search doesn't exist
            $.ajax({
              url: '/admin/students/search',
              data: { q: query },
              success: function(data){
                displayUserSuggestions(data.students || []);
              },
              error: function(err){
                console.error('Search error:', err);
                $('#user_suggestions').empty().hide();
              }
            });
          }
        });
      });

      // Click outside to close suggestions
      $(document).on('click', function(e) {
        if (!$(e.target).closest('.autocomplete-container').length) {
          $('#user_suggestions').hide();
        }
      });
    }

    function displayUserSuggestions(users) {
      let html = '';
      if (users.length === 0) {
        html = '<div class="suggestion-item-empty">No users found</div>';
      } else {
        users.forEach(function(user){
          const initials = (user.first_name.charAt(0) + user.last_name.charAt(0)).toUpperCase();
          const roleColor = getRoleColor(user.role);
          
          html += `
            <div class="suggestion-item" data-user='${JSON.stringify(user)}'>
              <div class="d-flex align-items-center">
                <div class="suggestion-avatar me-2">
                  ${user.profile_picture ? 
                    `<img src="/${user.profile_picture}" alt="Profile" class="suggestion-img">` :
                    `<div class="suggestion-initials">${initials}</div>`
                  }
                </div>
                <div class="flex-grow-1">
                  <div class="suggestion-name">${user.first_name} ${user.last_name}</div>
                  <div class="suggestion-details">
                    <span class="badge bg-${roleColor} me-1">${user.role}</span>
                    ${user.email} ${user.department ? '• ' + user.department : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
      }
      
      $('#user_suggestions').html(html).show();

      // Handle suggestion clicks
      $('.suggestion-item').on('click', function(){
        const userData = $(this).data('user');
        if (userData) {
          selectUser(userData);
        }
      });
    }

    function selectUser(user) {
      selectedUser = user;
      $('#user_id').val(user.id);
      $('#user_search').val(`${user.first_name} ${user.last_name}`);
      $('#user_suggestions').hide();

      // Update selected user display
      const initials = (user.first_name.charAt(0) + user.last_name.charAt(0)).toUpperCase();
      $('#user_initials').text(initials);
      $('#user_name').text(`${user.first_name} ${user.last_name}`);
      $('#user_details').text(`${user.email} • ${user.role} ${user.department ? '• ' + user.department : ''}`);
      $('#selected_user_display').removeClass('d-none');

      updateSummary();
    }

    function clearUserSelection() {
      selectedUser = null;
      $('#user_id').val('');
      $('#user_search').val('');
      $('#selected_user_display').addClass('d-none');
      $('#user_suggestions').hide();
      updateSummary();
    }

    function validateCardUID() {
      const cardUID = $('#card_uid').val().trim();
      const input = $('#card_uid');
      
      if (cardUID.length === 0) {
        input.removeClass('is-valid is-invalid');
        return false;
      }

      // Check for valid UID format (alphanumeric, 4-20 characters)
      const uidPattern = /^[A-Za-z0-9]{4,20}$/;
      
      if (!uidPattern.test(cardUID)) {
        input.removeClass('is-valid').addClass('is-invalid');
        $('#card_uid_error').text('Card UID must be 4-20 alphanumeric characters');
        return false;
      }

      input.removeClass('is-invalid').addClass('is-valid');
      return true;
    }

    function updatePreview() {
      const cardUID = $('#card_uid').val().trim();
      $('#preview_uid').text(cardUID || 'Enter UID');
    }

    function updateStatusDisplay() {
      const isActive = $('#is_active').is(':checked');
      $('.status-text').text(isActive ? 'Active' : 'Inactive');
    }

    function updateSummary() {
      const cardUID = $('#card_uid').val().trim();
      const isActive = $('#is_active').is(':checked');
      
      $('#summary_uid').text(cardUID || 'Not set');
      $('#summary_user').text(selectedUser ? `${selectedUser.first_name} ${selectedUser.last_name}` : 
                              ($('#user_search').val() || 'Unassigned'));
      $('#summary_status').text(isActive ? 'Active' : 'Inactive');
    }

    function generateRandomUID() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      $('#card_uid').val(result).trigger('input');
    }

    function getRoleColor(role) {
      const colors = {
        'admin': 'danger',
        'professor': 'warning',
        'guardian': 'info',
        'student': 'success'
      };
      return colors[role] || 'secondary';
    }

    // Enhanced form submission
    $('#editCardForm').on('submit', function(e) {
      e.preventDefault();
      
      if (!validateCardUID()) {
        return;
      }

      const form = $(this);
      const submitBtn = $('#updateBtn');
      const originalHtml = submitBtn.html();
      
      submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Updating...');
      
      // Prepare form data
      const formData = form.serialize();
      
      $.ajax({
        url: form.attr('action'),
        method: 'POST',
        data: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        success: function(response) {
          // Close modal
          const modalElement = document.getElementById('appModal');
          if (modalElement) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
              modalInstance.hide();
            }
          }
          
          // Show success message
          if (window.showToast) {
            window.showToast('Success!', 'RFID card updated successfully.', 'success');
          }
          
          // Reload page to show updated card
          setTimeout(() => window.location.reload(), 1000);
        },
        error: function(xhr) {
          submitBtn.prop('disabled', false).html(originalHtml);
          
          let errorMsg = 'An error occurred. Please try again.';
          
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            errorMsg = xhr.responseText;
          }
          
          // Show error message
          if (window.showToast) {
            window.showToast('Error', errorMsg, 'error');
          }
          
          // Show error in form
          const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>${errorMsg}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          
          $('.alert').remove();
          form.prepend(alertHtml);
        }
      });
    });
  </script>

  <style>
    /* Enhanced Edit Form Styles */
    .modal-content-wrapper {
      max-width: 900px;
      margin: 0 auto;
    }

    .icon-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(var(--bs-warning-rgb), 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .card-info-header .card {
      border-left: 4px solid var(--bs-primary);
    }

    .card-icon {
      text-align: center;
    }

    .section {
      border-bottom: 1px solid var(--bs-border-color);
      padding-bottom: 1.5rem;
    }

    .section:last-child {
      border-bottom: none;
    }

    .section-header h5 {
      color: var(--bs-primary);
      font-weight: 600;
    }

    .required::after {
      content: " *";
      color: var(--bs-danger);
    }

    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--bs-border-color);
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1050;
      display: none;
    }

    .suggestion-item {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid var(--bs-border-color);
      transition: all 0.2s ease;
    }

    .suggestion-item:hover {
      background: var(--bs-primary-bg-subtle);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item-empty {
      padding: 0.75rem;
      text-align: center;
      color: var(--bs-secondary);
      font-style: italic;
    }

    .suggestion-avatar {
      width: 35px;
      height: 35px;
    }

    .suggestion-img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }

    .suggestion-initials {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.8rem;
    }

    .suggestion-name {
      font-weight: 600;
      color: var(--bs-body-color);
    }

    .suggestion-details {
      font-size: 0.85rem;
      color: var(--bs-secondary);
    }

    .selected-user-card {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-avatar {
      width: 50px;
      height: 50px;
    }

    .profile-initials {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .form-check-lg .form-check-input {
      width: 2rem;
      height: 1rem;
    }

    .summary-item {
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--bs-border-color);
    }

    .summary-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .card-preview .card {
      border: 2px dashed var(--bs-border-color);
      transition: all 0.3s ease;
    }

    .card-preview .card:hover {
      border-color: var(--bs-primary);
      transform: translateY(-2px);
    }

    .current-assignment {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Dark mode support */
    [data-bs-theme="dark"] .suggestions-dropdown {
      background: var(--bs-dark);
      border-color: var(--bs-border-color);
    }

    [data-bs-theme="dark"] .suggestion-item:hover {
      background: var(--bs-secondary-bg);
    }
  </style>
</body>
</html>
