<div class="modal-content-wrapper">
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="fas fa-link me-2"></i>Guardian Link Details
    </h5>
  </div>
  
  <div class="modal-body">
    <!-- Link Summary Card -->
    <div class="card mb-4 border-primary">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-info-circle me-2"></i>Link Summary
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <strong>Link ID:</strong> #<%= link.id %><br>
            <strong>Created:</strong> <%= new Date(link.created_at).toLocaleString() %><br>
            <% if (link.updated_at && link.updated_at !== link.created_at) { %>
              <strong>Last Updated:</strong> <%= new Date(link.updated_at).toLocaleString() %><br>
            <% } %>
          </div>
          <div class="col-md-6">
            <% if (link.relationship_type) { %>
              <strong>Relationship:</strong> 
              <span class="badge bg-info"><%= link.relationship_type.charAt(0).toUpperCase() + link.relationship_type.slice(1) %></span><br>
            <% } %>
            <strong>Status:</strong> 
            <span class="badge bg-success">
              <i class="fas fa-check-circle me-1"></i>Active
            </span>
          </div>
        </div>
        <% if (link.notes) { %>
          <hr>
          <div class="mt-3">
            <strong>Notes:</strong>
            <p class="mt-2 mb-0 text-muted"><%= link.notes %></p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Guardian and Student Information -->
    <div class="row">
      <!-- Guardian Information -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 border-success">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="fas fa-user-shield me-2"></i>Guardian Information
            </h6>
          </div>
          <div class="card-body">
            <% if (link.guardian) { %>
              <div class="d-flex align-items-start mb-3">
                <div class="guardian-profile-picture me-3">
                  <% if (link.guardian.profile_picture) { %>
                    <img src="/<%= link.guardian.profile_picture.startsWith('/') ? link.guardian.profile_picture.substring(1) : link.guardian.profile_picture %>" 
                         alt="Guardian Profile" class="profile-picture-large">
                  <% } else { %>
                    <div class="profile-initials-large">
                      <%= link.guardian.first_name.charAt(0).toUpperCase() %><%= link.guardian.last_name.charAt(0).toUpperCase() %>
                    </div>
                  <% } %>
                </div>
                <div class="flex-grow-1">
                  <h5 class="mb-1"><%= link.guardian.first_name %> <%= link.guardian.last_name %></h5>
                  <p class="text-muted mb-2">
                    <i class="fas fa-envelope me-1"></i><%= link.guardian.email %>
                  </p>
                  <% if (link.guardian.school_id) { %>
                    <p class="text-muted mb-2">
                      <i class="fas fa-id-card me-1"></i><%= link.guardian.school_id %>
                    </p>
                  <% } %>
                  <span class="badge bg-<%= link.guardian.role === 'admin' ? 'danger' : link.guardian.role === 'professor' ? 'warning' : 'info' %>">
                    <%= link.guardian.role.charAt(0).toUpperCase() + link.guardian.role.slice(1) %>
                  </span>
                </div>
              </div>

              <div class="guardian-details">
                <div class="row">
                  <div class="col-sm-6">
                    <small class="text-muted">User ID</small>
                    <p class="mb-2">#<%= link.guardian.id %></p>
                  </div>
                  <% if (link.guardian.school_id) { %>
                    <div class="col-sm-6">
                      <small class="text-muted">School ID</small>
                      <p class="mb-2"><%= link.guardian.school_id %></p>
                    </div>
                  <% } %>
                </div>
                <% if (link.guardian.department) { %>
                  <div class="row">
                    <div class="col-sm-6">
                      <small class="text-muted">Department</small>
                      <p class="mb-2"><span class="badge bg-secondary"><%= link.guardian.department %></span></p>
                    </div>
                  </div>
                <% } %>
                <div class="row">
                  <div class="col-sm-6">
                    <small class="text-muted">Account Created</small>
                    <p class="mb-0"><%= new Date(link.guardian.created_at).toLocaleDateString() %></p>
                  </div>
                  <div class="col-sm-6">
                    <small class="text-muted">Last Login</small>
                    <p class="mb-0">
                      <% if (link.guardian.last_login) { %>
                        <%= new Date(link.guardian.last_login).toLocaleDateString() %>
                      <% } else { %>
                        <span class="text-muted">Never</span>
                      <% } %>
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-3 pt-3 border-top">
                <div class="d-flex gap-2">
                  <a href="/admin/users/<%= link.guardian.id %>" class="btn btn-sm btn-outline-success" data-modal="true">
                    <i class="fas fa-eye me-1"></i>View Profile
                  </a>
                  <a href="/admin/users/<%= link.guardian.id %>/edit" class="btn btn-sm btn-outline-warning" data-modal="true">
                    <i class="fas fa-edit me-1"></i>Edit
                  </a>
                </div>
              </div>
            <% } else { %>
              <div class="text-center text-muted py-3">
                <i class="fas fa-user-times fa-3x mb-2 opacity-25"></i>
                <p>No guardian information available</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Student Information -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 border-primary">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="fas fa-graduation-cap me-2"></i>Student Information
            </h6>
          </div>
          <div class="card-body">
            <% if (link.student) { %>
              <div class="d-flex align-items-start mb-3">
                <div class="student-profile-picture me-3">
                  <% if (link.student.profile_picture) { %>
                    <img src="/<%= link.student.profile_picture.startsWith('/') ? link.student.profile_picture.substring(1) : link.student.profile_picture %>" 
                         alt="Student Profile" class="profile-picture-large">
                  <% } else { %>
                    <div class="profile-initials-large">
                      <%= link.student.first_name.charAt(0).toUpperCase() %><%= link.student.last_name.charAt(0).toUpperCase() %>
                    </div>
                  <% } %>
                </div>
                <div class="flex-grow-1">
                  <h5 class="mb-1"><%= link.student.first_name %> <%= link.student.last_name %></h5>
                  <p class="text-muted mb-2">
                    <i class="fas fa-envelope me-1"></i><%= link.student.email %>
                  </p>
                  <% if (link.student.school_id) { %>
                    <p class="text-muted mb-2">
                      <i class="fas fa-id-card me-1"></i><%= link.student.school_id %>
                    </p>
                  <% } %>
                  <span class="badge bg-success">Student</span>
                </div>
              </div>

              <div class="student-details">
                <div class="row">
                  <div class="col-sm-6">
                    <small class="text-muted">User ID</small>
                    <p class="mb-2">#<%= link.student.id %></p>
                  </div>
                  <% if (link.student.school_id) { %>
                    <div class="col-sm-6">
                      <small class="text-muted">School ID</small>
                      <p class="mb-2"><%= link.student.school_id %></p>
                    </div>
                  <% } %>
                </div>
                <% if (link.student.department) { %>
                  <div class="row">
                    <div class="col-sm-6">
                      <small class="text-muted">Department</small>
                      <p class="mb-2"><span class="badge bg-secondary"><%= link.student.department %></span></p>
                    </div>
                    <% if (link.student.year) { %>
                      <div class="col-sm-6">
                        <small class="text-muted">Year Level</small>
                        <p class="mb-2"><span class="badge bg-info">Year <%= link.student.year %></span></p>
                      </div>
                    <% } %>
                  </div>
                <% } %>
                <div class="row">
                  <div class="col-sm-6">
                    <small class="text-muted">Enrolled</small>
                    <p class="mb-0"><%= new Date(link.student.created_at).toLocaleDateString() %></p>
                  </div>
                  <div class="col-sm-6">
                    <small class="text-muted">Last Activity</small>
                    <p class="mb-0">
                      <% if (link.student.last_login) { %>
                        <%= new Date(link.student.last_login).toLocaleDateString() %>
                      <% } else { %>
                        <span class="text-muted">Never</span>
                      <% } %>
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-3 pt-3 border-top">
                <div class="d-flex gap-2">
                  <a href="/admin/users/<%= link.student.id %>" class="btn btn-sm btn-outline-primary" data-modal="true">
                    <i class="fas fa-eye me-1"></i>View Profile
                  </a>
                  <a href="/admin/users/<%= link.student.id %>/edit" class="btn btn-sm btn-outline-warning" data-modal="true">
                    <i class="fas fa-edit me-1"></i>Edit
                  </a>
                </div>
              </div>
            <% } else { %>
              <div class="text-center text-muted py-3">
                <i class="fas fa-user-times fa-3x mb-2 opacity-25"></i>
                <p>No student information available</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Relationship Visualization -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-sitemap me-2"></i>Relationship Visualization
        </h6>
      </div>
      <div class="card-body">
        <div class="relationship-diagram">
          <div class="d-flex justify-content-center align-items-center">
            <!-- Guardian Node -->
            <div class="relationship-node guardian-node">
              <div class="node-avatar">
                <% if (link.guardian && link.guardian.profile_picture) { %>
                  <img src="/<%= link.guardian.profile_picture.startsWith('/') ? link.guardian.profile_picture.substring(1) : link.guardian.profile_picture %>" 
                       alt="Guardian" class="node-image">
                <% } else if (link.guardian) { %>
                  <div class="node-initials">
                    <%= link.guardian.first_name.charAt(0).toUpperCase() %><%= link.guardian.last_name.charAt(0).toUpperCase() %>
                  </div>
                <% } %>
              </div>
              <div class="node-info">
                <strong><%= link.guardian ? link.guardian.first_name + ' ' + link.guardian.last_name : 'Unknown Guardian' %></strong>
                <small class="d-block text-muted">Guardian</small>
              </div>
            </div>

            <!-- Relationship Arrow -->
            <div class="relationship-arrow">
              <div class="arrow-line"></div>
              <div class="arrow-label">
                <% if (link.relationship_type) { %>
                  <span class="badge bg-info"><%= link.relationship_type %></span>
                <% } else { %>
                  <span class="badge bg-secondary">Guardian</span>
                <% } %>
              </div>
              <div class="arrow-head">→</div>
            </div>

            <!-- Student Node -->
            <div class="relationship-node student-node">
              <div class="node-avatar">
                <% if (link.student && link.student.profile_picture) { %>
                  <img src="/<%= link.student.profile_picture.startsWith('/') ? link.student.profile_picture.substring(1) : link.student.profile_picture %>" 
                       alt="Student" class="node-image">
                <% } else if (link.student) { %>
                  <div class="node-initials">
                    <%= link.student.first_name.charAt(0).toUpperCase() %><%= link.student.last_name.charAt(0).toUpperCase() %>
                  </div>
                <% } %>
              </div>
              <div class="node-info">
                <strong><%= link.student ? link.student.first_name + ' ' + link.student.last_name : 'Unknown Student' %></strong>
                <small class="d-block text-muted">Student</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity Timeline -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-clock me-2"></i>Recent Activity Timeline
        </h6>
      </div>
      <div class="card-body">
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker bg-primary">
              <i class="fas fa-link"></i>
            </div>
            <div class="timeline-content">
              <h6 class="mb-1">Guardian Link Created</h6>
              <p class="text-muted mb-1">Link established between guardian and student</p>
              <small class="text-muted"><%= new Date(link.created_at).toLocaleString() %></small>
            </div>
          </div>
          
          <% if (link.updated_at && link.updated_at !== link.created_at) { %>
            <div class="timeline-item">
              <div class="timeline-marker bg-warning">
                <i class="fas fa-edit"></i>
              </div>
              <div class="timeline-content">
                <h6 class="mb-1">Link Updated</h6>
                <p class="text-muted mb-1">Guardian link information was modified</p>
                <small class="text-muted"><%= new Date(link.updated_at).toLocaleString() %></small>
              </div>
            </div>
          <% } %>

          <!-- Placeholder for future activity logs -->
          <div class="timeline-item">
            <div class="timeline-marker bg-info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="timeline-content">
              <h6 class="mb-1">Activity Monitoring</h6>
              <p class="text-muted mb-1">Future activity logs will appear here</p>
              <small class="text-muted">Coming soon...</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-bolt me-2"></i>Quick Actions
        </h6>
      </div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <a href="/admin/guardian-link/<%= link.id %>/edit" class="btn btn-warning" data-modal="true">
            <i class="fas fa-edit me-1"></i>Edit Link
          </a>
          <button type="button" class="btn btn-info" onclick="exportLinkDetails(<%= link.id %>)">
            <i class="fas fa-download me-1"></i>Export Details
          </button>
          <button type="button" class="btn btn-success" onclick="sendNotification(<%= link.id %>)">
            <i class="fas fa-bell me-1"></i>Send Notification
          </button>
          <button type="button" class="btn btn-outline-danger" onclick="deleteLinkConfirm(<%= link.id %>)">
            <i class="fas fa-trash me-1"></i>Delete Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
      <i class="fas fa-times me-1"></i>Close
    </button>
    <a href="/admin/guardian-link/<%= link.id %>/edit" class="btn btn-primary" data-modal="true">
      <i class="fas fa-edit me-1"></i>Edit Link
    </a>
  </div>
</div>

<script>
function exportLinkDetails(linkId) {
  fetch(`/admin/guardian-links/${linkId}/export`, {
    method: 'GET'
  })
  .then(response => response.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `guardian-link-${linkId}-details.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('error', 'Failed to export link details');
  });
}

function sendNotification(linkId) {
  if (confirm('Send notification to both guardian and student about this link?')) {
    fetch(`/admin/guardian-links/${linkId}/notify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('success', 'Notifications sent successfully');
      } else {
        showToast('error', data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('error', 'Failed to send notifications');
    });
  }
}

function deleteLinkConfirm(linkId) {
  if (confirm('Are you sure you want to delete this guardian link? This action cannot be undone.')) {
    fetch(`/admin/guardian-links/bulk-delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ linkIds: [linkId] })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('success', data.message);
        // Close modal and refresh parent page
        bootstrap.Modal.getInstance(document.querySelector('.modal')).hide();
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showToast('error', data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('error', 'Failed to delete guardian link');
    });
  }
}
</script>

<style>
.profile-picture-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--bs-border-color);
}

.profile-initials-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 24px;
  border: 3px solid var(--bs-border-color);
}

/* Relationship Visualization */
.relationship-diagram {
  padding: 2rem 1rem;
}

.relationship-node {
  text-align: center;
  padding: 1rem;
  border-radius: 10px;
  background: var(--bs-body-bg);
  border: 2px solid var(--bs-border-color);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-width: 150px;
}

.guardian-node {
  border-color: var(--bs-success);
  background: var(--bs-success-bg-subtle);
}

.student-node {
  border-color: var(--bs-primary);
  background: var(--bs-primary-bg-subtle);
}

.node-avatar {
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: center;
}

.node-image {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--bs-border-color);
}

.node-initials {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
  border: 2px solid var(--bs-border-color);
}

.relationship-arrow {
  display: flex;
  align-items: center;
  margin: 0 2rem;
  position: relative;
}

.arrow-line {
  width: 60px;
  height: 2px;
  background: var(--bs-primary);
  position: relative;
}

.arrow-label {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
}

.arrow-head {
  font-size: 1.5rem;
  color: var(--bs-primary);
  margin-left: -5px;
}

/* Timeline */
.timeline {
  position: relative;
  padding-left: 2rem;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--bs-border-color);
}

.timeline-item {
  position: relative;
  margin-bottom: 2rem;
}

.timeline-marker {
  position: absolute;
  left: -2rem;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  border: 2px solid var(--bs-body-bg);
}

.timeline-content {
  background: var(--bs-body-bg);
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid var(--bs-border-color);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .relationship-diagram {
    padding: 1rem 0.5rem;
  }
  
  .relationship-node {
    min-width: 120px;
    padding: 0.5rem;
  }
  
  .relationship-arrow {
    margin: 0 1rem;
  }
  
  .arrow-line {
    width: 40px;
  }
  
  .timeline {
    padding-left: 1.5rem;
  }
  
  .timeline-marker {
    left: -1.5rem;
    width: 25px;
    height: 25px;
    font-size: 10px;
  }
}

/* Dark mode support */
[data-bs-theme="dark"] .relationship-node {
  background: var(--bs-dark);
  border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .guardian-node {
  background: var(--bs-success-bg-subtle);
  border-color: var(--bs-success);
}

[data-bs-theme="dark"] .student-node {
  background: var(--bs-primary-bg-subtle);
  border-color: var(--bs-primary);
}

[data-bs-theme="dark"] .timeline-content {
  background: var(--bs-dark);
  border-color: var(--bs-border-color);
}
</style>
